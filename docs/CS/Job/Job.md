## Introduction



## 任务模型

- Cron
- Fixed Delay
- Fixed Rate
- One Time 一次性任务
  适用日历提醒, 订单超时自动关闭 因为Job占用资源较多 当任务量过大时 可使用MQ做定时消息, 或者秒级Map任务扫库处理



## 任务分配

- 单机
- 广播
- MapReduce模型








任务堆积

同MQ中消息堆积, 需考虑限流措施


任务超时


任务重试


重复消费


任务分配



以闲鱼小法庭案例

由分配制转向申领制 将比较重的用户鉴权和捞取数据移动到任务处理外 防止任务超时
分配制随机抽取会使部分用户反感, 前期可以投递优惠权益引流 用户参与, 让用户主动申请  增长用户黏度


对单个用户控制队列长度 

任务过快消费 造成用户资源浪费

在单个任务里对投票用户数量做限制 尽量在满足最低终止条件时 分配别的任务给用户 但只能尽力



Spring兼容性

大多都采用了processor的接口方案，用户通过接口继承实现调度任务即可，或者使用提供的方法注解，由框架自动生成代理processor 

   

## Comparison

对比

| **项目**     | **Quartz**                     | **Elastic-Job**                    | **XXL-JOB**                                | **SchedulerX**                                               | PowerJob |
| ------------ | ------------------------------ | ---------------------------------- | ------------------------------------------ | ------------------------------------------------------------ | --- |
| 定时调度     | Cron                           | Cron                               | Cron                                       | Cron、Fixed_Delay、Fixed_Rate、One_Time、OpenAPI             |Cron|
| 任务编排     | 不支持                         | 不支持                             | 不支持                                     | 支持，可以通过图形化配置，并且任务间可传递数据               |支持|
| 分布式跑批   | 不支持                         | 静态分片                           | 广播                                       | 广播、静态分片、MapReduce                                    |广播、静态分片、MapReduce|
| 多语言       | Java                           | Java、脚本任务                     | Java、Go、脚本任务                         | Java、Go、脚本任务、HTTP任务、K8s Job                        ||
| 可观测       | 无                             | 弱，只能查看无法动态创建、修改任务 | 历史记录、运行日志（不支持搜索）、监控大盘 | 历史记录、运行日志（支持搜索）、监控大盘、操作记录、查看堆栈、链路追踪 ||
| 可运维       | 无                             | 启用、禁用任务                     | 启用、禁用任务、手动运行任务、停止任务     | 启用、禁用任务、手动运行任务、停止任务、标记成功、重刷历史数据 ||
| 报警监控     | 无                             | 邮件                               | 邮件                                       | 邮件、钉钉、飞书、企业微信、自定义WebHook、短信、电话        ||
| 高可用及容灾 | 需要自己维护数据库的容灾       | 需要自己维护ZooKeeper的容灾        | 需要自己维护数据库和Server的容灾           | 默认支持同城多机房容灾                                       ||
| 用户权限     | 无                             | 无                                 | 用户隔离，通过账号密码登录                 | 支持单点登录、主子账号、角色账号、RAM精细化权限管理          ||
| 优雅下线     | 不支持                         | 不支持                             | 支持                                       | 支持                                                         ||
| 灰度测试     | 不支持                         | 不支持                             | 不支持                                     | 支持                                                         ||
| 性能         | 每次调度通过DB抢锁，对DB压力大 | ZooKeeper是性能瓶颈                | 由Master节点调度，Master节点压力大         | 可水平扩展，支持海量任务调度                                 ||





## Links



## References

1. [闲鱼技术 浅谈任务分发中的机制与并发](https://mp.weixin.qq.com/s/nGMxR7QDnoolTU5SYIDy2A)