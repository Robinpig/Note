## Introduction

推荐系统主要是由数据、算法、架构三个方面组成

- **数据提供了信息**。数据储存了信息，包括用户与内容的属性，用户的行为偏好例如对新闻的点击、玩过的英雄、购买的物品等等。这些数据特征非常关键，甚至可以说它们决定了一个算法的上限。
- **算法提供了逻辑**。数据通过不断的积累，存储了巨量的信息。在巨大的数据量与数据维度下，人已经无法通过人工策略进行分析干预，因此需要基于一套复杂的信息处理逻辑，基于逻辑返回推荐的内容或服务。
- **架构解放了双手**。架构保证整个推荐自动化、实时性的运行。架构包含了接收用户请求，收集、处理，存储用户数据，推荐算法计算，返回推荐结果等。有了架构之后算法不再依赖于手动计算，可以进行实时化、自动化的运行。例如在淘宝推荐中，对于数据实时性的处理，就保证了用户在点击一个物品后，后续返回的推荐结果就可以立刻根据该点击而改变。一个推荐系统的实时性要求越高、访问量越大那么这个推荐系统的架构就会越复杂



推荐的框架主要有以下几个模块：

- **协议调度**：请求的发送和结果的回传。在请求中，用户会发送自己的 ID，地理位置等信息。结果回传中会返回推荐系统给用户推荐的结果。
- **推荐算法**：算法按照一定的逻辑为用户产生最终的推荐结果。不同的推荐算法基于不同的逻辑与数据运算过程。
- **消息队列**：数据的上报与处理。根据用户的 ID，拉取例如用户的性别、之前的点击、收藏等用户信息。而用户在 APP 中产生的新行为，例如新的点击会储存在存储单元里面。
- **存储单元**：不同的数据类型和用途会储存在不同的存储单元中，例如内容标签与内容的索引存储在 mysql 里，实时性数据存储在 redis 里，需要进行数据统计的数据存储在 TDW 里



## 用户画像

**标签是我们对多维事物的降维理解，抽象出事物更具有代表性的特点。** 我们永远无法完全的了解一个人，所以我们只能够通过一个一个标签的来刻画他，所有的标签最终会构建为一个立体的画像，一个详尽的用户画像可以帮助我们更加好的理解用户



##### **原始数据**

原始数据一共包含四个方面：

- **用户数据：** 例如用户的性别、年龄、渠道、注册时间、手机机型等。
- **内容数据：** 例如游戏的品类，对游戏描述、评论的爬虫之后得到的关键词、标签等。
- **用户与内容的交互：** 基于用户的行为，了解了什么样的用户喜欢什么样的游戏品类、关键词、标签等。
- **外部数据：** 单一的产品只能描述用户的某一类喜好，例如游戏的喜好、视频的喜好，外部数据标签可以让用户更加的立体



##### **事实标签**

事实标签可以分为静态画像和动态画像：

- **静态画像：** 用户独立于产品场景之外的属性，例如用户的自然属性，这类信息比较稳定，具有统计性意义。
- **动态画像：** 用户在场景中所产生的显示行为或隐式行为。
- **显示行为**：用户明确的表达了自己的喜好，例如点赞、分享、关注、评分等。（评论的处理更加复杂，需要通过 NLP 的方式来判断用户的感情是正向、负向、中性）。
- **隐式行为**：用户没有明确表达自己的喜好，但“口嫌体正直”，用户会用实际行动，例如点击、停留时长等隐性的行为表达自己的喜好。

隐式行为的权重往往不会有显示行为大，但是在实际业务中，用户的显示行为都是比较稀疏的，所以需要依赖大量的隐式行为



##### **模型标签**

模型标签是由事实标签通过加权计算或是聚类分析所得。通过一层加工处理后，标签所包含的信息量得到提升，在推荐过程中效果更好。

- **聚类分析：** 例如按照用户的活跃度进行聚类，将用户分为高活跃-中活跃-低活跃三类。
- **加权计算：** 根据用户的行为将用户的标签加权计算，得到每一个标签的分数，用于之后推荐算法的计算



## **内容画像**

推荐内容与场景通常可以分为以下几类，根据所推荐的内容不同，其内容画像的处理方式也不同。

- 文章推荐：例如新闻内容推荐，需要利用NLP的技术对文章的标题，正文等提取关键词、标签、分类等。
- 视频推荐：除了对于分类、标题关键词的抓取外，还依赖于图片与视频处理技术，例如识别内容标签、内容相似性等

#### **环境变量**

内容画像外，环境画像也非常重要。例如在短视频的推荐场景中，用户在看到一条视频所处的时间、地点以及当时所浏览的前后内容、当天已浏览时间等也是非常重要的信息，但由于环境变量数据量较大、类型较多，对推荐架构以及工程实现能力的要求也较高



## 算法

推荐算法其实本质上是一种信息处理逻辑，当获取了用户与内容的信息之后，按照一定的逻辑处理信息后，产生推荐结果。热度排行榜就是最简单的一种推荐方法，它依赖的逻辑就是当一个内容被大多数用户喜欢，那大概率其他用户也会喜欢。但是基于粗放的推荐往往会不够精确，想要挖掘用户个性化的，小众化的兴趣，需要制定复杂的规则运算逻辑，并由机器完成。

推荐算法主要分为以下几步：

- **召回**：当用户以及内容量比较大的时候，往往先通过召回策略，将百万量级的内容先缩小到百量级。
- **过滤**：对于内容不可重复消费的领域，例如实时性比较强的新闻等，在用户已经曝光和点击后不会再推送到用户面前。
- **精排**：对于召回并过滤后的内容进行排序，将百量级的内容并按照顺序推送。
- **混排**：为避免内容越推越窄，将精排后的推荐结果进行一定修改，例如控制某一类型的频次。
- **强规则**：根据业务规则进行修改，例如在活动时将某些文章置顶







## TPP

个性化开发平台（The Personalization Platform，简称TPP)，面向算法和工程同学，支持召回、在线预测等业务编排的开发平台，专注于推荐、搜索、广告行业。提供成熟的工程框架，帮助算法从资源管理、运维中解放出来，专注业务逻辑开发、业务效果实验



TPP的主要用户是搜推广业务的算法同学，以推荐你喜欢的商品为例，来看服务的上线过程：算法同学训练好模型并部署到在线召回引擎、打分引擎，把用户和商品特征数据导入到特征存储，然后就需要让这套数据和模型在线对外提供服务。此时算法同学可以在TPP上创建这个业务场景，并用Java编写业务逻辑。常见的猜你喜欢推荐逻辑是：构建特征（调特征数据库） -> 召回商品（调召回引擎） -> 商品打分（调打分引擎） -> 商品排序 -> 补充商品详情（调详情数据库） -> 输出结果，**可见TPP上的业务逻辑像胶水一样把各类引擎的数据和模型预测结果粘合起来，经过业务加工产出推荐结果。**算法同学基于TPP图化框架实现引擎调用、数据加工，完成业务逻辑开发，在TPP平台上编译并调试，调试无误后发布上线，这时上游系统就可以调用这套推荐服务了。TPP平台在背后完成了容器的部署和拉起、服务的热部署、随着流量波动做机器资源的弹性扩缩。除了基础的在线服务能力外，算法同学可以对流量做分配、打标以完成不同配置的实验；可以利用TPP提供的监控报警、问题排查产品解决线上问题；可以利用TPP提供的分层降级、集群限流、流量兜底等能力保证服务稳定运行



在线服务的请求由用户动作触发，在线服务链路总响应时间一般在几百毫秒，留给链路中一个环节的时间一般不超过300毫秒，然而个性化算法链路有着大量数据读取、数据加工过程，是重CPU和重IO类型的服务。同时在线服务的性能与个性化算法效果相互制约，这体现在个性化算法效果越好就对数据的丰富度、模型复杂度要求越高，从而提高服务响应时长造成超时率增加，超时后的请求一般使用效果平平的兜底数据，从而制约总体算法效果。为此，TPP平台围绕算法在线服务的性能做了多方面工作，其中如何加速业务逻辑执行和业务数据加工是重要的一方面。



在构建特征 -> 召回商品 -> 商品打分 -> 商品排序 -> 补充商品详情 -> 输出结果流程中，需要调多次特征数据库，因为需要丰富的用户和商品特征，需要调多次召回引擎，因为需要多种类型的召回来源，显然，并发的去请求这些数据能显著缩短总处理耗时，然而算法同学并不专长于写并发代码，容易写出BUG或写的性能不高。另一方面，召回后的商品信息是以itemId为主键的多行多列数据，在送往打分、排序等后续流程中，需要根据业务需求做多次加工，例如数据合并、算分、排序、截断、去重等等，这些加工操作代码复杂，容易出错，且会产生大量内存碎片影响性能。基于上述并发需求和数据加工需求，我们推出了TPP图化框架和TPP DataFrame高性能数据集，目标是在提供极致开发体验的前提下，提供极致的性能。



TPP图化框架从19年开始研发，最初定位于利用可执行图结构解决并发性能问题，在图框架内提供数据集操作算子以优化数据加工性能，同时框架抽象层次得以提高从而获得更多优化空间。用户可以用stream api风格的接口构建业务执行图，这是一张数据流图，每个节点是一段业务逻辑，数据从上游节点流转到下游节点，在每个节点被加工处理，相互没有依赖的节点就可以并发执行。图引擎是一个全异步响应式执行引擎，同时对AI·OS引擎的接口均做了异步化改造，从而实现全异步、无阻塞、高并发的业务执行过程。当时改造为图化的业务普遍得到了20%~30%的性能提升。



在图化的推广中我们发现，数据流加工思路与用户熟悉的Java面向对象思路差异较大，学习成本高、调试困难、配套产品不完善，许多同学望而生退。为此TPP图化一方面推出依赖声明式构图、面向对象风格开发方式来降低学习成本，另一方面利用图可编排，有结构化信息的特点，推出了子图组件+在线编排开发方式和图执行过程可视化产品，同时跟一线的算法工程团队合作产出以TPP图化为基础的业务框架和产品，这些业务框架和产品更贴近自己的业务，同时也能利用图化的性能优势和图化公共产品。经过近三年的发展，TPP图化收获了诸多不同业务类型的用户，其中阿里云Saas智能推荐产品Airec就是基于TPP图化框架，Airec有效利用了图编排能力和性能优势帮助用户快速搭建高性能推荐服务。在阿里内部，TPP图化已经被几十个BU所使用，TPP图化日常承载了百万级的QPS，帮助业务普遍提升了30%的性能。

 

**在当前的时间点上，TPP图化仍聚焦在优化性能和提升开发体验上，希望最终能把TPP图化打造成算法在线服务领域易用、性能极致、迭代效率远超普通方式的产品**





## References

1. [从零开始了解推荐系统全貌](https://mp.weixin.qq.com/s/n1PB5LGppaxlfRWx8WxhLg)
1. [打造算法在线服务领域极致开发体验与性能 — 阿里TPP图化框架技术实践-阿里云开发者社区](https://developer.aliyun.com/article/933235)

