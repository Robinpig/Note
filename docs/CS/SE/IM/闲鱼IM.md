## Introduction





与一般IM会话模型不同的是，闲鱼会话以商品为主体，“人＋人+商品”为要素构建会话。
因会话模型的差异，淘系已有的消息系统，短期内无法满足业务需求，而闲鱼完全自建消息系统耗时巨大
为了保障业务高效上线，技术选型上最大化复用已有系统能力，避免重复造轮子。

所以，我们的技术方案是：

1. 数据模型与底层存储依赖淘系私信体系进行建设；
2. 消息数据获取上，客户端全量从服务端拉取消息数据；
3. 通讯协议使用来往SDK及mtop。


MobileMSDK

开发包快速切换用户 IMpass 消息还是发送到原有的客户端 且仍持续收到消息
但是点击进去报错 鉴权失败 报错 无权访问此session



下推的消息未达

感知长连中断并重连只能在大多数时间保证长连接的有效性，但是在长连接无效或不稳定期间下推的消息客户端可能根本收不到。

**简单说就是仅仅有重连机制无法保证下行消息必达，可能有以下场景导致下行消息失败：**

- ***1）\***服务端发送下行消息时长连畅通，消息在传输路上通道断掉，客户端无法收到；
- ***2）\***设备的在线状态存在延迟，服务端下行消息时认为设备在线，实际上设备已经离线，无法收到；
- ***3）\***客户端收到了下行消息，但端上后续处理失败（比如落库失败，消息没有成功展示给用户）

消息同步模型是推拉结合模式

**客户端主动拉取消息的触发时机主要有以下几个：**

- ***1）\***用户冷启动app，主动同步消息;
- ***2）\***用户主动下拉刷新；
- ***3）\***app后台切换前台；
- ***4）\***收到一条推送消息，客户端发现新消息的位点跟本地最新的位点有gap，触发同步。

上述主动同步消息的触发很大程度上依赖用户行为或者有没有收到新消息，难以保证消息及时到达。

如果是用户高频打开的IM软件，这样也不会有太大的问题。但是闲鱼app的活跃度较低，有时候甚至依赖IM消息拉活，而且一条延迟的消息触达可能导致用户错过一笔交易，闲鱼消息不允许有这样的延迟发生。

## 增加长连接重连机制

### 4.1长连接为什么会中断？

有因必有果，我们先来分析下有哪些原因会导致连接中断。

**对于IM这种场景下来说，通常可能有以下原因：**

- ***1）\***用户设备断网；
- ***2）\***设备发生了网络切换；
- ***3）\***设备处于弱网环境，网络不稳定；
- ***4）\***设备网络正常，TCP连接由于NAT超时导致连接被运营商中断。

对于APP来说，如果是用户操作导致网络状态变化的情况，会有网络状态变化事件通知，这种情况可以监听事件并主动尝试重连。但现实中的大多数情况都是“意料之外”（正如上面列举的这些断网可能性一样



像大多数链路保活场景一样，IM这种场景下最有效的检测手段就是心跳检测

心跳策略是实现我们上述目标的核心机制，本文仅简单列举几种心跳策略。

**比如以下这几种：**



- ***1）\***短心跳检测 初始状态连续 ping 3次 收到 ACK 后，可以认为进入稳定状态；
- ***2）\***常规固定时长心跳（根据app状态不同，频率可调Mid+,Mid-, Long)；
- ***3）\***自适应心跳 根据设备网络状态变化自动适应的心跳间隔；
- ***4）\***冗余心跳，app后台切前台，主动心跳一次



同时也引入了消息ACK应答与重发机制。

**整体思路是：**客户端在收到ACCS消息并处理成功后，给服务端回一个ACK应答包，服务端下发ACCS消息时将消息加入重试队列，收到ACK应答包后更新消息到达状态，并终止重试。















## Links

- [IM](/docs/CS/SE/IM/IM.md)
