## Introduction

即时消息（Instant Messaging，IM），又称实时消息，是一个可以支持在线交流的常见功能场景
IM并不是一门仅限于聊天、社交的技术 包括聊天、直播、在线客服、物联网等这些业务领域在内，所有需要“实时互动”“高实时性”的场景，都需要IM技术



核心场景 A客户端发送消息到服务器 服务器发送下行消息到客户端B

基本要求: 可达有序 不重不漏（QoS2 + 时序性）
-消息要及时可达
-消息不重复遗漏
-消息时序 接收端消息保证是按发送时间排序


## Architecture




## 消息协议

消息协议设计


协议从纵向可以分成三个层次: 应用层、安全层、传输层

应用层 协议有两种 文本协议和二进制协议 当前应用场景首选二进制协议 业界用 protobuf




安全层
- TLS/SSL 加密效果好 证书管理复杂
- 固定加密 客户端和服务端约定好密钥和加密算法
- 一人一密 通信前客户端申请请求密钥 服务端用用户特有属性生成密钥下发
- 一次一密 会话级别加密 接近于 TLS

加密消耗CPU 资源

网关层对数据包进行TLS3.0协议协商握手 加解密操作 可以使用GPU进行加解密



传输层

TCP 和 UDP 的对比


开源协议

小团队 XMPP 或者 MQTT + HTTP 短连接实现 反之需要自己设计实现私有协议 + Protobuf

- IMPP
- XMPP
- SIMPLE
- MQTT 扩展性差 需要定制化改造以支持时序性
- websocket
- 私有协议 + Protobuf





## Implementations

业界 IM：腾讯 QQ、腾讯微信、网易云通讯、抖音 IM、钉钉 IM、脉脉 IM、支付宝 IM








群聊消息

基于传统的 IM 架构技术，尤其在群内聊天或者分享，每条消息按照群内人数进行写扩散，按照主互动 500 人群规模来计算，平均群大小 320+，1:N 的写入必然导致写入 DB 的 RT 以及存储压力，
实际参与互动分享的用户在峰值的时候远大于这部分互动分享和聊天消息流量，其次集群的写入不可能完全给 IM 聊天消息，还有其它的营销活动、交易、物流等通知类型的消息
基于“写扩散”架构，在高并发互动场景下遇到了瓶颈，导致消息大量的延迟下推，影响最终用户体验
针对群内的消息可以分为“非个性化消息”和“个性化消息”，所谓“非个性化消息”就是大家看到都是一样的，应该只需要写一条数据，群内成员可以共享取这条数据，所谓“个性化消息”，指定某个成员发送的单边消息，譬如进群欢迎语等
在群内，99.99%都是“非个性化消息”，也就是可以从 1:N 压缩到 1:1 写入，基于这个理论假设，需要考虑“读扩散”让每个用户的消息从对应的“群会话消息队列同步“数据，而不是从”用户队列同步“数据，其中同步队列围绕队列 offset 偏移量进行，通过队列的自增 syncId 保证有序，每个客户端维护相应的队列的同步位点，采取“客户端存储位点的去中心化“方案，实现”下行消息的推拉“结合，通过队列位点 syncId 进行比对，如果服务端消息队列 syncId-客户端队列 syncId=1，表示云端消息无空洞，否则携带客户端的队列和对应的 syncId 到云端重新同步区间数据，实现最终一致性。
市面上 APP80%都具备 IM 聊天能力，均采取写扩散简单模式进行云端消息同步

写扩散技术
优点：
 整体架构简洁，方案简单，维护用户同步队列实现数据同步机制。
 无论是单聊还是群聊等会话消息，写入用户维度同步队列，集中获取同步数据。 推和拉情况下，存储模型和数据处理简单，且天然支持个性化数据
缺点：
 群会话消息，天然存在 1:N 写入扩散比，存储压力 N 倍压力，在线用户收到消息延迟增大。
 多个群内消息队列混合在同步队列，无优先级处理能力，无法针对互动群等做隔离。

读扩散技术
优点：
 降低写扩散 N 倍的 DB 存储压力，减少下行在线用户端到端扩散的 RT 时间。 提升消息上行集群整体的吞吐量，用户体验更流畅。
 端到端实现会话级别的同步优先级队列，实现差异化服务。
缺点：
 整体架构偏复杂，需要维护每个动态会话消息同步队列，端侧需要实时感知新增的动态同步队列。
 客户端冷启动需要分散读取多个会话消息同步队列数据，对于存储会带来读 QPS 压力

直播间
直播场景大直播间和小直播间的差距极大
对于大直播间可以提前做好直播分片
针对可靠消息（红包、优惠、宝贝卡片）等进行持久化存储，利用多次消息下推携带机制，同时兼顾端侧拉取机制，保证消息最终一致性且在 3 秒以内到达端侧


## 闲鱼

与一般IM会话模型不同的是，闲鱼会话以商品为主体，“人＋人+商品”为要素构建会话。
因会话模型的差异，淘系已有的消息系统，短期内无法满足业务需求，而闲鱼完全自建消息系统耗时巨大
为了保障业务高效上线，技术选型上最大化复用已有系统能力，避免重复造轮子。

所以，我们的技术方案是：
1. 数据模型与底层存储依赖淘系私信体系进行建设；
2. 消息数据获取上，客户端全量从服务端拉取消息数据；
3. 通讯协议使用来往SDK及mtop。


MobileMSDK



## Links



